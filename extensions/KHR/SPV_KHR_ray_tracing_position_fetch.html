<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.23">
<title>SPV_KHR_ray_tracing_position_fetch</title>
<style>
@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";
@import "https://cdn.jsdelivr.net/gh/asciidoctor/asciidoctor@2.0/data/stylesheets/asciidoctor-default.css";

p {
    font-family: Arial, Helvetica, sans-serif;
    line-height: normal;
}
em, b, strong {
    color: darkblue;
}

</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>SPV_KHR_ray_tracing_position_fetch</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_name_strings">Name Strings</a></li>
<li><a href="#_contact">Contact</a></li>
<li><a href="#_contributors">Contributors</a></li>
<li><a href="#_status">Status</a></li>
<li><a href="#_version">Version</a></li>
<li><a href="#_dependencies">Dependencies</a></li>
<li><a href="#_overview">Overview</a></li>
<li><a href="#_extension_name">Extension Name</a></li>
<li><a href="#_new_capabilities">New Capabilities</a></li>
<li><a href="#_new_builtins">New Builtins</a></li>
<li><a href="#_new_instructions">New Instructions</a></li>
<li><a href="#_modifications_to_the_spir_v_specification">Modifications to the SPIR-V Specification</a></li>
<li><a href="#_validation_rules">Validation Rules</a></li>
<li><a href="#_interactions_with_spv_khr_ray_tracing">Interactions with SPV_KHR_ray_tracing</a></li>
<li><a href="#_interactions_with_spv_khr_ray_query">Interactions with SPV_KHR_ray_query</a></li>
<li><a href="#_issues">Issues</a></li>
<li><a href="#_revision_history">Revision History</a></li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_name_strings">Name Strings</h2>
<div class="sectionbody">
<div class="paragraph">
<p>SPV_KHR_ray_tracing_position_fetch</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_contact">Contact</h2>
<div class="sectionbody">
<div class="paragraph">
<p>See <strong>Issues</strong> list in the Khronos SPIRV-Headers repository:
<a href="https://github.com/KhronosGroup/SPIRV-Headers" class="bare">https://github.com/KhronosGroup/SPIRV-Headers</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_contributors">Contributors</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Eric Werness, NVIDIA</p>
</li>
<li>
<p>Daniel Koch, NVIDIA</p>
</li>
<li>
<p>Alan Baker, Google</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_status">Status</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>2023-02-22 Approved by the SPIR Working Group</p>
</li>
<li>
<p>2023-04-14 Ratified by the Khronos Board</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_version">Version</h2>
<div class="sectionbody">
<table class="tableblock frame-all grid-all" style="width: 40%;">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Last Modified Date</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2023-04-21</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Revision</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect1">
<h2 id="_dependencies">Dependencies</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This extension is written against the Unified SPIR-V Specification,
Version 1.5, Revision 1.</p>
</div>
<div class="paragraph">
<p>This extension requires SPIR-V 1.4.</p>
</div>
<div class="paragraph">
<p>This extension requires SPV_KHR_ray_tracing or SPV_KHR_ray_query.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_overview">Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This extension adds functionality to ray pipelines and ray query to allow
fetching the vertex positions for the current hit.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_extension_name">Extension Name</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To use this extension within a SPIR-V module, the following
<strong>OpExtension</strong> must be present in the module:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>OpExtension "SPV_KHR_ray_tracing_position_fetch"</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_new_capabilities">New Capabilities</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This extension introduces two new capabilities:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>RayTracingPositionFetchKHR
RayQueryPositionFetchKHR</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_new_builtins">New Builtins</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Builtin added under the <strong>RayTracingPositionFetchKHR</strong> capability</p>
</div>
<div class="listingblock">
<div class="content">
<pre>HitTriangleVertexPositionsKHR</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_new_instructions">New Instructions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Instruction added under the <strong>RayQueryPositionFetchKHR</strong> capability</p>
</div>
<div class="listingblock">
<div class="content">
<pre>OpRayQueryGetIntersectionTriangleVertexPositionsKHR</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_modifications_to_the_spir_v_specification">Modifications to the SPIR-V Specification</h2>
<div class="sectionbody">
<div class="dlist">
<dl>
<dt class="hdlist1">(Modify Section 3.21, BuiltIn, adding rows to the BuiltIn table) </dt>
<dd>
<div class="openblock">
<div class="content">
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 5.8823%;">
<col style="width: 58.8235%;">
<col style="width: 35.2942%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle" colspan="2">BuiltIn</th>
<th class="tableblock halign-left valign-top"><a href="#Capability">Enabling Capabilities</a></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">5335</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a id="HitTriangleVertexPositionsKHR"></a><strong>HitTriangleVertexPositionsKHR</strong><br>
The vertex positions for the triangle hit for the ray being traced in the <strong>AnyHitKHR</strong> or
<strong>ClosestHitKHR</strong> execution models.+
+
Refer to the Ray Tracing chapter of Vulkan API specification for more details.</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><strong>RayTracingPositionFetchKHR</strong></p></td>
</tr>
</tbody>
</table>
</div>
</div>
</dd>
<dt class="hdlist1">(Modify Section 3.31, Capability, adding rows to the Capability table) </dt>
<dd>
<div class="openblock">
<div class="content">
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 2.439%;">
<col style="width: 60.9756%;">
<col style="width: 36.5854%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle" colspan="2"><a id="Capability"></a>Capability</th>
<th class="tableblock halign-left valign-top">Implicitly Declares</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">5336</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>RayTracingPositionFetchKHR</strong><br>
Uses the <a href="#HitTriangleVertexPositionsKHR"><strong>HitTriangleVertexPositionsKHR</strong></a> builtin.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>RayTracingKHR</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">5391</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>RayQueryPositionFetchKHR</strong><br>
Uses the <a href="#OpRayQueryGetIntersectionTriangleVertexPositionsKHR"><strong>OpRayQueryGetIntersectionTriangleVertexPositionsKHR</strong></a>
instruction.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>RayQueryKHR</strong></p></td>
</tr>
</tbody>
</table>
</div>
</div>
</dd>
<dt class="hdlist1">(Add to sub section 3.32.RQInstructions, Ray Query Instructions) </dt>
<dd>
<div class="openblock">
<div class="content">
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.667%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" colspan="5"><p class="tableblock"><a id="OpRayQueryGetIntersectionTriangleVertexPositionsKHR"></a><strong>OpRayQueryGetIntersectionTriangleVertexPositionsKHR</strong><br>
<br>
 Gets the vertex positions for the triangle at the current intersection.<br>
<br>
 <em>Result</em> is the returned vertex positions.<br>
<br>
 <em>Result Type</em> must be an array with a <em>Length</em> of 3, and an <em>Element Type</em> that is a vector type with a <em>Component Type</em> that is a 32-bit <em>floating-point type</em> and a <em>Component Count</em> of 3.<br>
<br>
 <em>Intersection</em> must be the &lt;id&gt; of a <em>constant instruction</em> with a 32-bit scalar <em>integer type</em>.<br>
<br>
 <em>Intersection</em> identifies which intersection values should be returned for, either the current candidate or the
 closest recorded hit so far; see <a href="https://htmlpreview.github.io/?https://github.com/KhronosGroup/SPIRV-Registry/blob/main/extensions/KHR/SPV_KHR_ray_query.html#ray_query_intersection">Ray Query Intersection</a>.<br>
<br>
 <em>Ray Query</em> is a pointer to the ray query object.<br>
<br>
 If <em>Intersection</em> is <strong>RayQueryCandidateIntersectionKHR</strong>, behavior is undefined if <strong>OpRayQueryProceedKHR</strong>
 was not executed on the same ray query object, or if the last value returned by such an execution of <strong>OpRayQueryProceedKHR</strong> was not true.
<br>
 If <em>Intersection</em> is <strong>RayQueryCommittedIntersectionKHR</strong>, behavior is undefined if there is no current committed
 intersection (see <strong>OpRayQueryCommittedTypeKHR</strong>).</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Capability:<br>
<strong>RayQueryPositionFetchKHR</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5340</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>&lt;id&gt;</em> <em>Result Type</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Result</em> <em>&lt;id&gt;</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>&lt;id&gt; Ray Query</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>&lt;id&gt; Intersection</em></p></td>
</tr>
</tbody>
</table>
</div>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_validation_rules">Validation Rules</h2>
<div class="sectionbody">
<div class="paragraph">
<p>An OpExtension must be added to the SPIR-V for validation layers to check
legal use of this extension:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>OpExtension "SPV_KHR_ray_tracing_position_fetch"</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_interactions_with_spv_khr_ray_tracing">Interactions with SPV_KHR_ray_tracing</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <strong>RayTracingPositionFetchKHR</strong> capability and the <strong>HitTriangleVertexPositionsKHR</strong> builtin
are only supported if SPV_KHR_ray_tracing and the <strong>RayTracingKHR</strong> capability are supported.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_interactions_with_spv_khr_ray_query">Interactions with SPV_KHR_ray_query</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <strong>RayQueryPositionFetchKHR</strong> capability and the <strong>OpRayQueryGetIntersectionTriangleVertexPositionsKHR</strong>
instruction are only supported if SPV_KHR_ray_query and the <strong>RayQueryKHR</strong> capability are supported.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_issues">Issues</h2>
<div class="sectionbody">
<div class="paragraph">
<p>1) Should triangle be in the name somewhere?</p>
</div>
<div class="paragraph">
<p>RESOLVED: Yes, though <strong>OpRayQueryGetIntersectionTriangleVertexPositionsKHR</strong> seems a bit long.</p>
</div>
<div class="paragraph">
<p>2) Where should the functionality of the new builtin and instruction be defined?</p>
</div>
<div class="paragraph">
<p>RESOLVED: Following precedent, ray tracing (pipeline) relies more on "Refer to the Ray Tracing
chapter of Vulkan API" language while ray query inlines more of the functionality definition
directly in the SPIR-V extensions.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_revision_history">Revision History</h2>
<div class="sectionbody">
<table class="tableblock frame-all grid-rows stretch">
<colgroup>
<col style="width: 4.7619%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Rev</th>
<th class="tableblock halign-left valign-top">Date</th>
<th class="tableblock halign-left valign-top">Author</th>
<th class="tableblock halign-left valign-top">Changes</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2022-05-12</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Eric Werness</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">First draft</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2022-12-14</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Daniel Koch</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use two capabilities and other spec cleanup.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2023-01-06</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Daniel Koch</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Follow SPIR-V conventions for undefined behavior.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2023-04-21</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Daniel Koch</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Add ratification status</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</body>
</html>