<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.23">
<title>SPV_INTEL_cache_controls</title>
<style>
@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";
@import "https://cdn.jsdelivr.net/gh/asciidoctor/asciidoctor@2.0/data/stylesheets/asciidoctor-default.css";

p {
    font-family: Arial, Helvetica, sans-serif;
    line-height: normal;
}
em, b, strong {
    color: darkblue;
}

</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>SPV_INTEL_cache_controls</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_name_strings">Name Strings</a></li>
<li><a href="#_contact">Contact</a></li>
<li><a href="#_contributors">Contributors</a></li>
<li><a href="#_notice">Notice</a></li>
<li><a href="#_status">Status</a></li>
<li><a href="#_version">Version</a></li>
<li><a href="#_dependencies">Dependencies</a></li>
<li><a href="#_overview">Overview</a></li>
<li><a href="#_extension_name">Extension Name</a></li>
<li><a href="#_new_capabilities">New Capabilities</a></li>
<li><a href="#_new_decorations">New Decorations</a></li>
<li><a href="#_token_number_assignments">Token Number Assignments</a></li>
<li><a href="#_modifications_to_the_spir_v_specification_version_1_6_revision_2">Modifications to the SPIR-V Specification, Version 1.6, Revision 2</a></li>
<li><a href="#_issues">Issues</a></li>
<li><a href="#_revision_history">Revision History</a></li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_name_strings">Name Strings</h2>
<div class="sectionbody">
<div class="paragraph">
<p>SPV_INTEL_cache_controls</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_contact">Contact</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To report problems with this extension, please open a new issue at:</p>
</div>
<div class="paragraph">
<p><a href="https://github.com/KhronosGroup/SPIRV-Registry" class="bare">https://github.com/KhronosGroup/SPIRV-Registry</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_contributors">Contributors</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Andrzej Ratajewski, Intel<br></p>
</li>
<li>
<p>Ben Ashbaugh, Intel<br></p>
</li>
<li>
<p>Dmitry Sidorov, Intel<br></p>
</li>
<li>
<p>Gregory Lueck, Intel<br></p>
</li>
<li>
<p>Victor Mustya, Intel<br></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_notice">Notice</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Copyright (c) 2023 Intel Corporation.  All rights reserved.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_status">Status</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Complete.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_version">Version</h2>
<div class="sectionbody">
<table class="tableblock frame-all grid-all" style="width: 40%;">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Last Modified Date</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2023-08-28</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Revision</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect1">
<h2 id="_dependencies">Dependencies</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This extension is written against the SPIR-V Specification, Version 1.6,
Revision 2.</p>
</div>
<div class="paragraph">
<p>This extension requires SPIR-V 1.0</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_overview">Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This extension allows cache control information to be applied to memory access
instructions.</p>
</div>
<div class="paragraph">
<p>The cache controls are a strong request that the SPIR-V consumer should use a
memory operation with the indicated cache controls. However, the SPIR-V consumer
may choose a different cache control if the requested one is unsupported or for
any other reason. The cache controls may affect the performance of a program,
but (with very few exceptions) must not affect the functional correctness.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_extension_name">Extension Name</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To use this extension within a SPIR-V module, the appropriate <strong>OpExtension</strong> must
be present in the module:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>OpExtension "SPV_INTEL_cache_controls"</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_new_capabilities">New Capabilities</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This extension introduces new capabilities:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>CacheControlsINTEL</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_new_decorations">New Decorations</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre>CacheControlLoadINTEL
CacheControlStoreINTEL</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_token_number_assignments">Token Number Assignments</h2>
<div class="sectionbody">
<table class="tableblock frame-all grid-rows" style="width: 40%;">
<colgroup>
<col style="width: 70%;">
<col style="width: 30%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>CacheControlsINTEL</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">6441</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>CacheControlLoadINTEL</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">6442</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>CacheControlStoreINTEL</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">6443</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect1">
<h2 id="_modifications_to_the_spir_v_specification_version_1_6_revision_2">Modifications to the SPIR-V Specification, Version 1.6, Revision 2</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_validation_rules">Validation Rules</h3>
<div class="paragraph">
<p>Modify Section 2.16.1, Universal Validation Rules, adding the following statements.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Decoration rules</p>
<div class="ulist">
<ul>
<li>
<p>A <strong>CacheControlLoadINTEL</strong> Decoration must be applied only as follows:</p>
<div class="ulist">
<ul>
<li>
<p>Only <strong>OpTypePointer</strong> values can be decorated.</p>
</li>
<li>
<p>Pointer types of the decorated instructions must have <strong>Function</strong>,
<strong>UniformConstant</strong>, <strong>CrossWorkgroup</strong> or <strong>Generic</strong> storage class.</p>
</li>
<li>
<p>It&#8217;s allowed to apply <strong>CacheControlLoadINTEL</strong> multiple times to the same
<em>Pointer</em>.</p>
</li>
<li>
<p>Two <strong>CacheControlLoadINTEL</strong> decorations decorating the same <em>Pointer</em>
must have different <em>Cache Level</em> values.</p>
</li>
</ul>
</div>
</li>
<li>
<p>A <strong>CacheControlStoreINTEL</strong> Decoration must be applied only as follows:</p>
<div class="ulist">
<ul>
<li>
<p>Only <strong>OpTypePointer</strong> values can be decorated.</p>
</li>
<li>
<p>Pointer types of the decorated instructions must have <strong>Function</strong>,
<strong>CrossWorkgroup</strong> or <strong>Generic</strong> storage class.</p>
</li>
<li>
<p>It&#8217;s allowed to apply <strong>CacheControlStoreINTEL</strong> multiple times to the same
<em>Pointer</em>.</p>
</li>
<li>
<p>Two <strong>CacheControlStoreINTEL</strong> decorations decorating the same <em>Pointer</em>
must have different <em>Cache Level</em> values.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Modify Section 3, Binary form, add new sub-sections after 3.18 Access Qualifier.</p>
</div>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p><a id="Load_Cache_Control"></a><strong>3.XX Load Cache Controls</strong></p>
</div>
<table class="tableblock frame-all grid-all" style="width: 80%;">
<colgroup>
<col style="width: 1.6393%;">
<col style="width: 24.5901%;">
<col style="width: 24.5901%;">
<col style="width: 49.1805%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle" colspan="2">Cache Control</th>
<th class="tableblock halign-center valign-top">Enabling Capabilities</th>
<th class="tableblock halign-center valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>UncachedINTEL</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>CacheControlsINTEL</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hint that the load operation should not cache its data in the given cache
level.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>CachedINTEL</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>CacheControlsINTEL</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hint that the load operation should cache its data in the given cache level.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>StreamingINTEL</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>CacheControlsINTEL</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hint that the load operation should cache its data in the specified cache
level, using evict-first policy to minimize cache pollution caused by temporary
streaming data that may only be accessed once or twice.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>InvalidateAfterReadINTEL</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>CacheControlsINTEL</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">By using this control the SPIR-V generator is asserting that the cache line
containing the data will not be read again until it&#8217;s overwritten, therefore
the load operation can invalidate the cache line and discard "dirty" data. If
the assertion is violated (the cache line is read again) then behavior is
undefined.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>ConstCachedINTEL</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>CacheControlsINTEL</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">By using this control the SPIR-V generator is asserting that the cache line
containing the data will not be written until all invocations of the shader or
kernel execution are finished. If the assertion is violated (the cache line is
written), the behavior is undefined.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><a id="Store_Cache_Control"></a><strong>3.XX Store Cache Controls</strong></p>
</div>
<table class="tableblock frame-all grid-all" style="width: 80%;">
<colgroup>
<col style="width: 1.6393%;">
<col style="width: 24.5901%;">
<col style="width: 24.5901%;">
<col style="width: 49.1805%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle" colspan="2">Cache Control</th>
<th class="tableblock halign-center valign-top">Enabling Capabilities</th>
<th class="tableblock halign-center valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>UncachedINTEL</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>CacheControlsINTEL</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hint that the store or atomic operation should not cache its data in the
given cache level.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>WriteThroughINTEL</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>CacheControlsINTEL</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hint that the store or atomic operation should immediately write data to the
subsequent furthest cache, marking the cache line in the current cache as
"not dirty".</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>WriteBackINTEL</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>CacheControlsINTEL</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hint that the store or atomic operation should write data into the given
cache level and mark the cache line as "dirty". Upon eviction, "dirty" data
will be written into the furthest subsequent cache.</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-middle"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>StreamingINTEL</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>CacheControlsINTEL</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Same as <strong>WriteThroughINTEL</strong>, but use evict-first policy to limit cache
pollution by streaming output data.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_decorations">Decorations</h3>
<div class="paragraph">
<p>Modify Section 3.20, Decoration, adding rows to the Decoration table:</p>
</div>
<div class="openblock">
<div class="content">
<table class="tableblock frame-all grid-all" style="width: 80%;">
<colgroup>
<col style="width: 2.439%;">
<col style="width: 48.7804%;">
<col style="width: 12.1951%;">
<col style="width: 12.1951%;">
<col style="width: 24.3904%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top" colspan="2">Decoration</th>
<th class="tableblock halign-left valign-top" colspan="2">Extra Operands</th>
<th class="tableblock halign-left valign-top">Enabling Capabilities</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">6442</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>CacheControlLoadINTEL</strong><br>
Apply the cache controls to a <em>Pointer</em>.
The pointer must point to the <strong>Function</strong>, <strong>UniformConstant</strong>, <strong>CrossWorkgroup</strong>
or <strong>Generic</strong> <em>Storage Class</em>.<br>
<br>
If a memory-reading instruction uses the decorated pointer value as its input
parameter, the decoration is a hint that the load operation should be performed
with the specified cache semantics.<br>
<br>
<em>Cache Level</em> is an unsigned 32-bit integer telling the cache level to which
the control applies.  The value <code>0</code> indicates the cache level closest to the
processing unit, the value <code>1</code> indicates the next furthest cache level, etc.
If some cache level does not exist, the decoration is ignored.<br>
<br>
If the exact <em>Load Cache Control</em> value is unsupported, the consumer may apply
implementation-specific closest match, but only if it does not change the
observable effect of the requested <em>Load Cache Control</em>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Literal"><em>Literal</em></a><br>
<em>Cache Level</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Load_Cache_Control"><em>Load_Cache_Control</em></a><br>
<em>Cache Control</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>CacheControlsINTEL</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">6443</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>CacheControlStoreINTEL</strong><br>
Apply the cache controls to a <em>Pointer</em>.
The pointer must point to the <strong>Function</strong>, <strong>CrossWorkgroup</strong> or
<strong>Generic</strong> <em>Storage Class</em>.<br>
<br>
If a memory-writing or atomic instruction uses the decorated pointer value as
its input parameter, the decoration is a hint that the store operation should be
performed with the specified cache semantics.<br>
<br>
<em>Cache Level</em> is an unsigned 32-bit integer telling the cache level to which the
control applies. The value <code>0</code> indicates the cache level closest to the
processing unit, the value <code>1</code> indicates the next furthest cache level, etc. If
some cache level does not exist, the decoration is ignored.<br>
<br>
If the exact <em>Store Cache Control</em> value is unsupported, the consumer may apply
implementation-specific closest match, but only if it does not change the
observable effect of the requested <em>Store Cache Control</em>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Literal"><em>Literal</em></a><br>
<em>Cache Level</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#Store_Cache_Control"><em>Store_Cache_Control</em></a><br>
<em>Cache Control</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>CacheControlsINTEL</strong></p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_capabilities">Capabilities</h3>
<div class="paragraph">
<p>Modify Section 3.31, Capability, adding rows to the Capability table:</p>
</div>
<div class="openblock">
<div class="content">
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top" colspan="2">Capability</th>
<th class="tableblock halign-center valign-top">Implicitly Declares</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">6441</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>CacheControlsINTEL</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_issues">Issues</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>How the consumer should work with shareable data with cached controls, if
some cache level is non-coherent?<br>
<strong>RESOLVED</strong>: The cache controls defined as "hints" cannot break memory model. The
consumer must insert extra flush or invalidate operations to maintain the
memory model in case of non-coherent caches. The cache controls defined as
"assertions" may break memory model, so users should take care on undefined
behavior cases.</p>
</li>
<li>
<p>How to mark an operation "uncached" on all the available cache levels?<br>
<strong>RESOLVED</strong>: Use <strong>Nontemporal</strong> <em>Memory Operand</em> defined in core SPIR-V spec
instead of this extension.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_revision_history">Revision History</h2>
<div class="sectionbody">
<table class="tableblock frame-all grid-rows stretch">
<colgroup>
<col style="width: 4.7619%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Rev</th>
<th class="tableblock halign-left valign-top">Date</th>
<th class="tableblock halign-left valign-top">Author</th>
<th class="tableblock halign-left valign-top">Changes</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2023-08-28</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Victor Mustya</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Initial public revision</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</body>
</html>